<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Daily Pickup Log - Google Sheets Backend</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        .animate-spin {
            animation: spin 1s linear infinite;
        }
    </style>
</head>
<body class="bg-gray-50">
    <div id="app"></div>

    <script>
        // ============================================
        // CONFIGURATION - UPDATE THESE VALUES
        // ============================================
        
     const CONFIG = {
  SCRIPT_URL: 'https://script.google.com/macros/s/AKfycbwL6cDPU4BLJDNUOGYK4jYivbd45_4gTovHUixVApsZXRvUZTxol1d5OrqLT776mvDH/exec',
  SPREADSHEET_ID: '1lTFPGPptV5zEyXPVI3oosiop8GYzYNYvUezlIZZsPYk',
  SHEET_NAME: 'Sheet1'
};


        // ============================================
        // GOOGLE SHEETS DATABASE CLASS
        // ============================================

       class GoogleSheetsDB {
    constructor(config) {
        this.config = config;
        this.scriptUrl = config.SCRIPT_URL;
    }

    async getAllEntries() {
        try {
            const response = await fetch(`${this.scriptUrl}?action=getAllEntries`);
            const data = await response.json();
            return data.success ? data.data : [];
        } catch (error) {
            console.error('Error fetching entries:', error);
            return [];
        }
    }

    async addEntry(entry) {
        try {
            const response = await fetch(this.scriptUrl, {
                method: 'POST',
                headers: { 'Content-Type': 'text/plain;charset=utf-8' },   // ‚úÖ CORS safe
                body: JSON.stringify({
                    action: 'addEntry',
                    entry: entry
                })
            });
            const data = await response.json();
            return data;
        } catch (error) {
            console.error('Error adding entry:', error);
            throw error;
        }
    }

    async updateEntry(rowIndex, entry) {
        try {
            const response = await fetch(this.scriptUrl, {
                method: 'POST',
                headers: { 'Content-Type': 'text/plain;charset=utf-8' },   // ‚úÖ CORS safe
                body: JSON.stringify({
                    action: 'updateEntry',
                    rowIndex: rowIndex,
                    entry: entry
                })
            });
            const data = await response.json();
            return data;
        } catch (error) {
            console.error('Error updating entry:', error);
            throw error;
        }
    }

    async deleteEntry(rowIndex) {
        try {
            const response = await fetch(this.scriptUrl, {
                method: 'POST',
                headers: { 'Content-Type': 'text/plain;charset=utf-8' },   // ‚úÖ CORS safe
                body: JSON.stringify({
                    action: 'deleteEntry',
                    rowIndex: rowIndex
                })
            });
            const data = await response.json();
            return data;
        } catch (error) {
            console.error('Error deleting entry:', error);
            throw error;
        }
    }

    async archiveCompleted() {
        try {
            const response = await fetch(this.scriptUrl, {
                method: 'POST',
                headers: { 'Content-Type': 'text/plain;charset=utf-8' },   // ‚úÖ CORS safe
                body: JSON.stringify({
                    action: 'archiveCompleted'
                })
            });
            const data = await response.json();
            return data;
        } catch (error) {
            console.error('Error archiving entries:', error);
            throw error;
        }
    }
}

        // ============================================
        // APPLICATION CLASS
        // ============================================

        class PickupLogApp {
            constructor() {
                this.db = new GoogleSheetsDB(CONFIG);
                this.state = {
                    entries: [],
                    stats: { total: 0, completed: 0, pending: 0, issues: 0 },
                    loading: true,
                    searchTerm: '',
                    filterStatus: 'all',
                    showAddModal: false,
                    showArchiveModal: false,
                    userName: localStorage.getItem('pickupLogUser') || '',
                    showUserModal: !localStorage.getItem('pickupLogUser'),
                    formData: this.getEmptyForm()
                };
                
                this.init();
            }

            getEmptyForm() {
                return {
                    date: new Date().toISOString().split('T')[0],
                    client: '',
                    shipTo: '',          // NEW
                    order: '',
                    pallets: '',
                    carrier: '',
                    pickupNum: '',
                    scheduledDate: '',
                    bolProvided: false,
                    printedByOps: false,
                    pickupComplete: false,
                    completedDate: '',
                    qualityCheck: false,
                    comments: ''
                };
            }

            async init() {
                if (this.state.userName) {
                    await this.loadEntries();
                    setInterval(() => this.loadEntries(), 120000); // 2 minutes
                }
                this.render();
            }

            async loadEntries() {
                this.state.loading = true;
                this.render();
                
                const entries = await this.db.getAllEntries();
                this.state.entries = entries.filter(e => e.id);
                this.calculateStats();
                this.state.loading = false;
                this.render();
            }

            calculateStats() {
                const entries = this.state.entries;
                this.state.stats = {
                    total: entries.length,
                    completed: entries.filter(e => e.pickupComplete).length,
                    pending: entries.filter(e => !e.pickupComplete).length,
                    issues: entries.filter(e => e.pickupComplete && !e.qualityCheck).length
                };
            }

            getFilteredEntries() {
                return this.state.entries.filter(entry => {
                    const term = this.state.searchTerm.toLowerCase();
                    const searchMatch = 
                        entry.client.toLowerCase().includes(term) ||
                        (entry.shipTo || '').toLowerCase().includes(term) || // NEW
                        entry.order.toLowerCase().includes(term) ||
                        entry.carrier.toLowerCase().includes(term) ||
                        entry.pickupNum.toLowerCase().includes(term);

                    const filterMatch = 
                        this.state.filterStatus === 'all' ? true :
                        this.state.filterStatus === 'completed' ? entry.pickupComplete :
                        this.state.filterStatus === 'pending' ? !entry.pickupComplete :
                        this.state.filterStatus === 'issues' ? entry.pickupComplete && !entry.qualityCheck : true;

                    return searchMatch && filterMatch;
                });
            }

            async handleAddEntry() {
                try {
                    await this.db.addEntry(this.state.formData);
                    this.state.showAddModal = false;
                    this.state.formData = this.getEmptyForm();
                    await this.loadEntries();
                } catch (error) {
                    alert('Error adding entry. Please try again.');
                }
            }

            async handleUpdateEntry(id, field, value) {
                const index = this.state.entries.findIndex(e => e.id === id);
                if (index === -1) return;

                this.state.entries[index][field] = value;
                
                try {
                    await this.db.updateEntry(index, this.state.entries[index]);
                    this.calculateStats();
                    this.render();
                } catch (error) {
                    alert('Error updating entry. Please try again.');
                    await this.loadEntries();
                }
            }

            async handleDeleteEntry(id) {
                if (!confirm('Are you sure you want to delete this entry?')) return;

                const index = this.state.entries.findIndex(e => e.id === id);
                if (index === -1) return;

                try {
                    await this.db.deleteEntry(index);
                    await this.loadEntries();
                } catch (error) {
                    alert('Error deleting entry. Please try again.');
                }
            }

            // NEW: run archive via backend
            async runArchiveBOLs() {
                if (!confirm('This will move all completed pickups from the dashboard to the Archive sheet. Continue?')) {
                    return;
                }

                try {
                    const result = await this.db.archiveCompleted();
                    alert(`Archived pickups: ${result.archived || 0}`);
                    await this.loadEntries();
                    this.state.showArchiveModal = false;
                    this.render();
                } catch (error) {
                    alert('Error archiving pickups. Please try again.');
                    console.error(error);
                }
            }

            exportToCSV() {
                const headers = [
                    'Date', 'Client', 'ShipTo', 'Order#', 'Pallets', 'Carrier',
                    'Pickup#', 'Scheduled', 'BOL', 'PrintedOPS',
                    'Complete', 'CompletedDate', 'QualityCheck', 'Comments'
                ];
                
                const csvData = this.state.entries.map(e => [
                    e.date,
                    e.client,
                    e.shipTo || '',
                    e.order,
                    e.pallets,
                    e.carrier,
                    e.pickupNum,
                    e.scheduledDate,
                    e.bolProvided ? 'Yes' : 'No',
                    e.printedByOps ? 'Yes' : 'No',
                    e.pickupComplete ? 'Yes' : 'No',
                    e.completedDate,
                    e.qualityCheck ? 'Yes' : 'No',
                    e.comments
                ]);

                const csv = [headers, ...csvData]
                    .map(row => row.map(cell => `"${cell}"`).join(','))
                    .join('\n');

                const blob = new Blob([csv], { type: 'text/csv' });
                const url = window.URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `pickup_log_${new Date().toISOString().split('T')[0]}.csv`;
                a.click();
                window.URL.revokeObjectURL(url);
            }

            formatDate(dateString) {
                if (!dateString) return '';
                const date = new Date(dateString);
                return date.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
            }

            render() {
                const app = document.getElementById('app');
                
                if (this.state.showUserModal) {
                    app.innerHTML = this.renderUserModal();
                    this.attachUserModalListeners();
                    return;
                }

                if (this.state.loading) {
                    app.innerHTML = this.renderLoading();
                    return;
                }

                app.innerHTML = this.renderMainApp();
                this.attachEventListeners();
            }

            renderUserModal() {
                return `
                    <div class="min-h-screen bg-gray-50 flex items-center justify-center p-6">
                        <div class="bg-white rounded-lg shadow-xl p-8 max-w-md w-full">
                            <div class="text-center mb-6">
                                <div class="text-6xl mb-4">üë•</div>
                                <h2 class="text-2xl font-bold text-indigo-900 mb-2">Welcome to Daily Pickup Log</h2>
                                <p class="text-gray-600">Please enter your name to continue</p>
                            </div>
                            <input id="userName" type="text" placeholder="Your name" value="${this.state.userName}"
                                class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-transparent mb-4">
                            <button id="submitUser" class="w-full bg-indigo-600 text-white px-4 py-3 rounded-lg hover:bg-indigo-700 transition">
                                Continue
                            </button>
                        </div>
                    </div>
                `;
            }

            renderLoading() {
                return `
                    <div class="min-h-screen bg-gray-50 flex items-center justify-center">
                        <div class="text-center">
                            <div class="animate-spin rounded-full h-12 w-12 border-b-2 border-indigo-600 mx-auto mb-4"></div>
                            <p class="text-gray-600">Loading pickup log...</p>
                        </div>
                    </div>
                `;
            }

            renderMainApp() {
                const filteredEntries = this.getFilteredEntries();
                return `
                    <div class="min-h-screen bg-gray-50 p-6">
                        ${this.renderHeader()}
                        ${this.renderStats()}
                        ${this.renderSearchBar()}
                        ${this.renderTable(filteredEntries)}
                        ${this.renderFooter()}
                        ${this.state.showAddModal ? this.renderAddModal() : ''}
                        ${this.state.showArchiveModal ? this.renderArchiveModal() : ''}
                    </div>
                `;
            }

            renderHeader() {
                return `
                    <div class="bg-white rounded-lg shadow-md p-6 mb-6">
                        <div class="flex items-center justify-between">
                            <div>
                                <h1 class="text-3xl font-bold text-indigo-900 mb-2">Daily Pick Up Log</h1>
                                <p class="text-gray-600">Transportation and Customer Service Operations</p>
                                <p class="text-sm text-gray-500 mt-1">
                                    Logged in as: <span class="font-semibold text-indigo-600">${this.state.userName}</span>
                                    <button onclick="app.changeUser()" class="ml-2 text-indigo-600 hover:underline text-xs">(change)</button>
                                </p>
                            </div>
                            <div class="flex gap-3">
                                <button onclick="app.loadEntries()" class="flex items-center gap-2 bg-gray-600 text-white px-4 py-2 rounded-lg hover:bg-gray-700 transition">
                                    üîÑ Refresh
                                </button>
                                <button onclick="app.state.showAddModal = true; app.render()" class="flex items-center gap-2 bg-green-600 text-white px-4 py-2 rounded-lg hover:bg-green-700 transition">
                                    ‚ûï Add Entry
                                </button>
                                <button onclick="app.state.showArchiveModal = true; app.render()" class="flex items-center gap-2 bg-indigo-600 text-white px-4 py-2 rounded-lg hover:bg-indigo-700 transition">
                                    üìÅ Archive BOLs
                                </button>
                                <button onclick="app.exportToCSV()" class="flex items-center gap-2 bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700 transition">
                                    üì• Export Excel
                                </button>
                            </div>
                        </div>
                        <div class="mt-4 text-sm text-gray-500">
                            Powered by Google Sheets ‚Ä¢ Last updated: ${new Date().toLocaleTimeString()} ‚Ä¢ Auto-refresh every 30 minutes
                        </div>
                    </div>
                `;
            }

            renderStats() {
                const { total, completed, pending, issues } = this.state.stats;
                return `
                    <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-6">
                        <div class="bg-white p-4 rounded-lg shadow">
                            <div class="flex items-center justify-between">
                                <div><p class="text-gray-500 text-sm">Total Pickups</p><p class="text-2xl font-bold text-indigo-900">${total}</p></div>
                                <div class="text-4xl">üì¶</div>
                            </div>
                        </div>
                        <div class="bg-white p-4 rounded-lg shadow">
                            <div class="flex items-center justify-between">
                                <div><p class="text-gray-500 text-sm">Completed</p><p class="text-2xl font-bold text-green-600">${completed}</p></div>
                                <div class="text-4xl">‚úÖ</div>
                            </div>
                        </div>
                        <div class="bg-white p-4 rounded-lg shadow">
                            <div class="flex items-center justify-between">
                                <div><p class="text-gray-500 text-sm">Pending</p><p class="text-2xl font-bold text-orange-600">${pending}</p></div>
                                <div class="text-4xl">‚è≥</div>
                            </div>
                        </div>
                        <div class="bg-white p-4 rounded-lg shadow">
                            <div class="flex items-center justify-between">
                                <div><p class="text-gray-500 text-sm">Quality Issues</p><p class="text-2xl font-bold text-red-600">${issues}</p></div>
                                <div class="text-4xl">‚ö†Ô∏è</div>
                            </div>
                        </div>
                    </div>
                `;
            }

            renderSearchBar() {
                return `
                    <div class="bg-white rounded-lg shadow-md p-4 mb-6">
                        <div class="flex gap-4 items-center">
                            <div class="flex-1 relative">
                                <span class="absolute left-3 top-1/2 transform -translate-y-1/2 text-gray-400">üîç</span>
                                <input id="searchInput" type="text" placeholder="Search by client, ship to, order, carrier, or pickup number..." value="${this.state.searchTerm}"
                                    class="w-full pl-10 pr-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-transparent">
                            </div>
                            <div class="flex items-center gap-2">
                                <span class="text-gray-500">üîΩ</span>
                                <select id="filterSelect" class="px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-transparent">
                                    <option value="all" ${this.state.filterStatus === 'all' ? 'selected' : ''}>All Entries</option>
                                    <option value="completed" ${this.state.filterStatus === 'completed' ? 'selected' : ''}>Completed Only</option>
                                    <option value="pending" ${this.state.filterStatus === 'pending' ? 'selected' : ''}>Pending Only</option>
                                    <option value="issues" ${this.state.filterStatus === 'issues' ? 'selected' : ''}>Quality Issues</option>
                                </select>
                            </div>
                        </div>
                    </div>
                `;
            }

            renderTable(entries) {
                const rows = entries.map(entry => `
                    <tr class="hover:bg-gray-50 transition">
                        <td class="px-4 py-3 text-sm">${this.formatDate(entry.date)}</td>
                        <td class="px-4 py-3 text-sm font-medium">${entry.client}</td>
                        <td class="px-4 py-3 text-sm">${entry.shipTo || ''}</td>
                        <td class="px-4 py-3 text-sm">${entry.order}</td>
                        <td class="px-4 py-3 text-sm text-center">${entry.pallets}</td>
                        <td class="px-4 py-3 text-sm">${entry.carrier}</td>
                        <td class="px-4 py-3 text-sm">${entry.pickupNum}</td>
                        <td class="px-4 py-3 text-sm">${this.formatDate(entry.scheduledDate)}</td>
                        <td class="px-4 py-3 text-center">
                            <input type="checkbox" ${entry.bolProvided ? 'checked' : ''} 
                                   onchange="app.handleUpdateEntry('${entry.id}', 'bolProvided', this.checked)"
                                   class="w-5 h-5 text-indigo-600 rounded cursor-pointer">
                        </td>
                        <td class="px-4 py-3 text-center">
                            <input type="checkbox" ${entry.printedByOps ? 'checked' : ''} 
                                   onchange="app.handleUpdateEntry('${entry.id}', 'printedByOps', this.checked)"
                                   class="w-5 h-5 text-indigo-600 rounded cursor-pointer">
                        </td>
                        <td class="px-4 py-3 text-center">
                            <input type="checkbox" ${entry.pickupComplete ? 'checked' : ''} 
                                   onchange="app.handleUpdateEntry('${entry.id}', 'pickupComplete', this.checked)"
                                   class="w-5 h-5 text-indigo-600 rounded cursor-pointer">
                        </td>
                        <td class="px-4 py-3 text-sm">${this.formatDate(entry.completedDate)}</td>
                        <td class="px-4 py-3 text-center">
                            <input type="checkbox" ${entry.qualityCheck ? 'checked' : ''} 
                                   onchange="app.handleUpdateEntry('${entry.id}', 'qualityCheck', this.checked)"
                                   class="w-5 h-5 text-indigo-600 rounded cursor-pointer">
                        </td>
                        <td class="px-4 py-3 text-sm max-w-xs truncate">${entry.comments}</td>
                        <td class="px-4 py-3 text-center">
                            <button onclick="app.handleDeleteEntry('${entry.id}')" class="text-red-600 hover:text-red-800" title="Delete">üóëÔ∏è</button>
                        </td>
                    </tr>
                `).join('');

                return `
                    <div class="bg-white rounded-lg shadow-md overflow-hidden">
                        <div class="overflow-x-auto">
                            <table class="w-full">
                                <thead class="bg-indigo-900 text-white">
                                    <tr>
                                        <th class="px-4 py-3 text-left text-sm font-semibold">Date</th>
                                        <th class="px-4 py-3 text-left text-sm font-semibold">Client</th>
                                        <th class="px-4 py-3 text-left text-sm font-semibold">Ship To</th>
                                        <th class="px-4 py-3 text-left text-sm font-semibold">Order#</th>
                                        <th class="px-4 py-3 text-left text-sm font-semibold">Pallets</th>
                                        <th class="px-4 py-3 text-left text-sm font-semibold">Carrier</th>
                                        <th class="px-4 py-3 text-left text-sm font-semibold">Pick up #</th>
                                        <th class="px-4 py-3 text-left text-sm font-semibold">Scheduled</th>
                                        <th class="px-4 py-3 text-center text-sm font-semibold">BOL</th>
                                        <th class="px-4 py-3 text-center text-sm font-semibold">OPS</th>
                                        <th class="px-4 py-3 text-center text-sm font-semibold">Complete</th>
                                        <th class="px-4 py-3 text-left text-sm font-semibold">Completed</th>
                                        <th class="px-4 py-3 text-center text-sm font-semibold">QC</th>
                                        <th class="px-4 py-3 text-left text-sm font-semibold">Comments</th>
                                        <th class="px-4 py-3 text-center text-sm font-semibold">Actions</th>
                                    </tr>
                                </thead>
                                <tbody class="divide-y divide-gray-200">
                                    ${rows.length > 0 ? rows : '<tr><td colspan="15" class="text-center py-12 text-gray-500">No entries found.</td></tr>'}
                                </tbody>
                            </table>
                        </div>
                    </div>
                `;
            }

            renderAddModal() {
                return `
                    <div class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
                        <div class="bg-white rounded-lg shadow-xl p-6 max-w-2xl w-full mx-4 max-h-[90vh] overflow-y-auto">
                            <div class="flex items-center justify-between mb-4">
                                <h2 class="text-2xl font-bold text-indigo-900">Add New Pickup Entry</h2>
                                <button onclick="app.state.showAddModal = false; app.render()" class="text-gray-500 hover:text-gray-700 text-2xl">√ó</button>
                            </div>
                            <div class="grid grid-cols-2 gap-4">
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-1">Date</label>
                                    <input id="formDate" type="date" value="${this.state.formData.date}"
                                        class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500">
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-1">Client</label>
                                    <select id="formClient"
                                        class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500">
                                        <option value="">Select client</option>
                                        <option value="Pierre Fabre">Pierre Fabre</option>
                                        <option value="BR">BR</option>
                                        <option value="Promix">Promix</option>
                                        <option value="Maeleys">Maeleys</option>
                                        <option value="Natura">Natura</option>
                                        <option value="Granado">Granado</option>
                                        <option value="VBB">VBB</option>
                                        <option value="Maison">Maison</option>
                                        <option value="Yves Roche">Yves Roche</option>
                                        <option value="LMC">LMC</option>
                                    </select>
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-1">Ship To / Retailer</label>
                                    <input id="formShipTo" type="text" placeholder="Ship To or Retailer"
                                        class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500">
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-1">Order Number</label>
                                    <input id="formOrder" type="text" placeholder="Order #"
                                        class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500">
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-1">Total Pallets</label>
                                    <input id="formPallets" type="number" placeholder="Number"
                                        class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500">
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-1">Carrier</label>
                                    <input id="formCarrier" type="text" placeholder="Carrier name"
                                        class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500">
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-1">Pickup Number</label>
                                    <input id="formPickupNum" type="text" placeholder="Pickup #"
                                        class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500">
                                </div>
                                <div class="col-span-2">
                                    <label class="block text-sm font-medium text-gray-700 mb-1">Scheduled Pickup Date</label>
                                    <input id="formScheduled" type="date"
                                        class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500">
                                </div>
                                <div class="col-span-2">
                                    <label class="block text-sm font-medium text-gray-700 mb-1">Comments</label>
                                    <textarea id="formComments" rows="3" placeholder="Additional notes"
                                        class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500"></textarea>
                                </div>
                                <div class="col-span-2 grid grid-cols-2 gap-4">
                                    <label class="flex items-center gap-2 cursor-pointer">
                                        <input id="formBOL" type="checkbox" class="w-5 h-5 text-indigo-600 rounded">
                                        <span class="text-sm font-medium text-gray-700">BOL Provided</span>
                                    </label>
                                    <label class="flex items-center gap-2 cursor-pointer">
                                        <input id="formPrintedOps" type="checkbox" class="w-5 h-5 text-indigo-600 rounded">
                                        <span class="text-sm font-medium text-gray-700">Printed by OPS</span>
                                    </label>
                                </div>
                            </div>
                            <div class="flex gap-3 mt-6">
                                <button onclick="app.submitAddForm()" class="flex-1 bg-indigo-600 text-white px-4 py-2 rounded-lg hover:bg-indigo-700 transition">Add Entry</button>
                                <button onclick="app.state.showAddModal = false; app.render()" class="flex-1 bg-gray-300 text-gray-700 px-4 py-2 rounded-lg hover:bg-gray-400 transition">Cancel</button>
                            </div>
                        </div>
                    </div>
                `;
            }

            renderArchiveModal() {
                return `
                    <div class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
                        <div class="bg-white rounded-lg shadow-xl p-6 max-w-2xl w-full mx-4">
                            <div class="flex items-center justify-between mb-4">
                                <h2 class="text-2xl font-bold text-indigo-900">BOL Archive System</h2>
                                <button onclick="app.state.showArchiveModal = false; app.render()" class="text-gray-500 hover:text-gray-700 text-2xl">√ó</button>
                            </div>
                            <div class="space-y-4">
                                <div class="bg-indigo-50 p-4 rounded-lg">
                                    <h3 class="font-semibold text-indigo-900 mb-2">Google Sheets Archive</h3>
                                    <p class="text-sm text-gray-700">Completed pickups will be moved from the live dashboard (Sheet1) to the "Archive" sheet.</p>
                                    <ul class="text-sm text-gray-700 list-disc list-inside mt-2">
                                        <li>Keeps the daily dashboard clean</li>
                                        <li>Full history stays in Google Sheets</li>
                                        <li>You can restore pickups from Archive using the Restore column + Tracker menu in Sheets</li>
                                    </ul>
                                </div>
                                <div class="bg-green-50 p-4 rounded-lg">
                                    <h3 class="font-semibold text-green-900 mb-2">Current Status</h3>
                                    <p class="text-sm text-gray-700">${this.state.stats.completed} completed pickup(s) ready to archive.</p>
                                </div>
                                <div class="flex gap-3">
                                    <button onclick="app.runArchiveBOLs()" class="flex-1 bg-indigo-600 text-white px-4 py-2 rounded-lg hover:bg-indigo-700 transition">
                                        Archive completed pickups now
                                    </button>
                                    <button onclick="window.open('https://docs.google.com/spreadsheets/d/${CONFIG.SPREADSHEET_ID}', '_blank')" class="flex-1 bg-gray-600 text-white px-4 py-2 rounded-lg hover:bg-gray-700 transition">
                                        Open Google Sheet
                                    </button>
                                    <button onclick="app.state.showArchiveModal = false; app.render()" class="flex-1 bg-gray-300 text-gray-700 px-4 py-2 rounded-lg hover:bg-gray-400 transition">
                                        Close
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
            }

            renderFooter() {
                return `
                    <div class="mt-6 bg-blue-50 border-l-4 border-blue-600 p-4 rounded">
                        <h3 class="font-semibold text-blue-900 mb-2">üìã Quality Check Requirements</h3>
                        <p class="text-sm text-blue-800">
                            Before marking "Pickup Complete," team members must verify packing quality and check the Quality Check box. 
                            This ensures proper stacking, no damage, and BOL accuracy before shipment leaves the facility.
                        </p>
                    </div>
                    <div class="mt-4 bg-green-50 border-l-4 border-green-600 p-4 rounded">
                        <h3 class="font-semibold text-green-900 mb-2">üíæ Google Sheets Backend</h3>
                        <p class="text-sm text-green-800">
                            All data is automatically saved to Google Sheets. Changes from team members appear after refresh (every 2 minutes).
                            You can access the raw data directly in Google Sheets for advanced reporting and analysis.
                        </p>
                    </div>
                `;
            }

            attachUserModalListeners() {
                const input = document.getElementById('userName');
                const button = document.getElementById('submitUser');
                
                if (input) {
                    input.addEventListener('input', (e) => this.state.userName = e.target.value);
                    input.addEventListener('keypress', (e) => { if (e.key === 'Enter') this.submitUserName(); });
                }
                if (button) button.addEventListener('click', () => this.submitUserName());
            }

            attachEventListeners() {
                const searchInput = document.getElementById('searchInput');
                if (searchInput) {
                    searchInput.addEventListener('input', (e) => {
                        this.state.searchTerm = e.target.value;
                        this.render();
                    });
                }

                const filterSelect = document.getElementById('filterSelect');
                if (filterSelect) {
                    filterSelect.addEventListener('change', (e) => {
                        this.state.filterStatus = e.target.value;
                        this.render();
                    });
                }
            }

            submitUserName() {
                if (this.state.userName.trim()) {
                    localStorage.setItem('pickupLogUser', this.state.userName.trim());
                    this.state.showUserModal = false;
                    this.init();
                }
            }

            changeUser() {
                const newUser = prompt('Enter your name:', this.state.userName);
                if (newUser && newUser.trim()) {
                    this.state.userName = newUser.trim();
                    localStorage.setItem('pickupLogUser', newUser.trim());
                    this.render();
                }
            }

            submitAddForm() {
                this.state.formData = {
                    date: document.getElementById('formDate').value,
                    client: document.getElementById('formClient').value,
                    shipTo: document.getElementById('formShipTo').value, // NEW
                    order: document.getElementById('formOrder').value,
                    pallets: document.getElementById('formPallets').value,
                    carrier: document.getElementById('formCarrier').value,
                    pickupNum: document.getElementById('formPickupNum').value,
                    scheduledDate: document.getElementById('formScheduled').value,
                    bolProvided: document.getElementById('formBOL').checked,
                    printedByOps: document.getElementById('formPrintedOps').checked,
                    pickupComplete: false,
                    completedDate: '',
                    qualityCheck: false,
                    comments: document.getElementById('formComments').value
                };
                this.handleAddEntry();
            }
        }

        // Initialize
        let app;
        window.addEventListener('DOMContentLoaded', () => {
            if (!CONFIG.SCRIPT_URL || CONFIG.SCRIPT_URL === '') {
                document.getElementById('app').innerHTML = `
                    <div class="min-h-screen bg-gray-50 flex items-center justify-center p-6">
                        <div class="bg-yellow-50 border-l-4 border-yellow-600 p-6 rounded-lg max-w-2xl">
                            <h2 class="text-2xl font-bold text-yellow-900 mb-4">‚öôÔ∏è Configuration Required</h2>
                            <p class="text-yellow-800 mb-4">Please update the SCRIPT_URL in the CONFIG section.</p>
                            <ol class="list-decimal list-inside text-yellow-800 space-y-2">
                                <li>Open your Google Sheet</li>
                                <li>Go to Extensions ‚Üí Apps Script</li>
                                <li>Deploy as Web App with "Anyone" access</li>
                                <li>Copy the Web App URL</li>
                                <li>Update SCRIPT_URL in line 24 of this file</li>
                            </ol>
                        </div>
                    </div>
                `;
                return;
            }
            app = new PickupLogApp();
        });
    </script>
</body>
</html>





