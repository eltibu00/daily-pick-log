<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Daily Pickup Log</title>
  <link rel="icon" href="data:,">
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    @keyframes spin { to { transform: rotate(360deg);} }
    .animate-spin { animation: spin 1s linear infinite; }
  </style>
</head>
<body class="bg-gray-50">
  <div id="app"></div>

  <script>
  // ================== CONFIG ==================
  const CONFIG = {
    SCRIPT_URL: 'https://script.google.com/macros/s/AKfycbwqA6hTkfj9ziHMUc6Cp1AHXw_9zrd5loFO0cilQngkmUs-0i08DmRt0sUp17cQIMb1/exec',
    SPREADSHEET_ID: '1lTFPGPptV5zEyXPVI3oosiop8GYzYNYvUezlIZZsPYk',
    SHEET_NAME: 'Sheet1',
    AUTO_ARCHIVE_DAYS: 30,
    // Users who can delete entries (case-insensitive)
    ADMINS: ['Roberto', 'Admin', 'Kafuti Lupasa', 'Norma Sandoval', 'Norma Hernandez']
  };

  // Client list for dropdown
  const CLIENTS = [
    'Biologique Recherche',
    'Granado Inc',
    'Havea',
    'LaCoste',
    'Limelife',
    'LMC',
    "Maely's",
    'Maison',
    'Natura',
    'Pierre Fabre',
    'Tiffany',
    'Victoria Beckam',
    'Yves Rocher',
    'Other'
  ];

  // Carrier list for dropdown
  const CARRIERS = [
     'Amazon Freight',
    'CTII',
    'Dynamic',
    'Estes',
    'FedEx Freight',
    'Gilbert',
    'Hercules',
    'JP Express',
    'Pitt Ohio',
    'R&L',
    'SaIa',
    'TForce',
    'WWE',
    'XPO',
    'YRC',
    'Other(note in comments)'
    
  ];

  // ============== Sheets API wrapper ==============
  class GoogleSheetsDB {
    constructor(cfg){ this.url = cfg.SCRIPT_URL; }

    async getAllEntries(){
      const r = await fetch(`${this.url}?action=getAllEntries`);
      const j = await r.json();
      return j.success ? j.data : [];
    }
    async getArchivedEntries(){
      const r = await fetch(`${this.url}?action=getArchivedEntries`);
      const j = await r.json();
      return j.success ? j.data : [];
    }
    async addEntry(entry){
      const r = await fetch(this.url,{method:'POST',headers:{'Content-Type':'text/plain;charset=utf-8'},body:JSON.stringify({action:'addEntry',entry})});
      return r.json();
    }
    async updateEntryById(id, entry){
      const r = await fetch(this.url,{method:'POST',headers:{'Content-Type':'text/plain;charset=utf-8'},body:JSON.stringify({action:'updateEntryById',id,entry})});
      return r.json();
    }
    async deleteEntryById(id){
      const r = await fetch(this.url,{method:'POST',headers:{'Content-Type':'text/plain;charset=utf-8'},body:JSON.stringify({action:'deleteEntryById',id})});
      return r.json();
    }
    async archiveCompleted(){
      const r = await fetch(this.url,{method:'POST',headers:{'Content-Type':'text/plain;charset=utf-8'},body:JSON.stringify({action:'archiveCompleted'})});
      return r.json();
    }
    async autoArchiveOld(days){
      const r = await fetch(this.url,{method:'POST',headers:{'Content-Type':'text/plain;charset=utf-8'},body:JSON.stringify({action:'autoArchiveOld',days})});
      return r.json();
    }
    async uploadBOL(id, fileName, fileData, mimeType){
      const r = await fetch(this.url,{method:'POST',headers:{'Content-Type':'text/plain;charset=utf-8'},body:JSON.stringify({action:'uploadBOL',id,fileName,fileData,mimeType})});
      return r.json();
    }
    async getBOLFolderUrl(){
      const r = await fetch(`${this.url}?action=getBOLFolderUrl`);
      const j = await r.json();
      return j.success ? j.url : null;
    }
  }

  // ================== App ==================
  class PickupLogApp {
    constructor(){
      this.db = new GoogleSheetsDB(CONFIG);
      this.state = {
        userName: localStorage.getItem('pickupLogUser') || '',
        userEmail: localStorage.getItem('pickupLogEmail') || '',
        showUserModal: !localStorage.getItem('pickupLogUser') || !localStorage.getItem('pickupLogEmail'),
        entries: [],
        archivedEntries: [],
        search: '',
        filter: 'all',
        stats: { total: 0, completed: 0, pending: 0, issues: 0 },
        showAdd: false,
        showArchive: false,
        editing: null,
        newForm: null,
        uploadingFor: null,
        bolFolderUrl: null,
        updating: new Set() // Track which rows are being updated
      };
      this.init();
    }

    isAdmin(){
      const user = this.state.userName.toLowerCase();
      return CONFIG.ADMINS.some(admin => admin.toLowerCase() === user);
    }

    emptyForm(){
      return {
        id: '',
        date: new Date().toISOString().split('T')[0],
        client: '',
        shipTo: '',
        order: '',
        pallets: '',
        carrier: '',
        pickupNum: '',
        scheduledDate: '',
        bolProvided: false,
        printedByOps: false,
        pickupComplete: false,
        completedDate: '',
        qualityCheck: false,
        comments: '',
        createdBy: this.state.userName,
        bolFile: '',
        bolFileName: '',
        completedBy: '',
        printedBy: ''
      };
    }

    async init(){
      if (this.state.userName) { 
        await this.load();
        // Get BOL folder URL
        this.state.bolFolderUrl = await this.db.getBOLFolderUrl();
        setInterval(()=>this.load(), 180000);
        await this.db.autoArchiveOld(CONFIG.AUTO_ARCHIVE_DAYS);
      }
      this.render();
    }

    async load(){
      const data = await this.db.getAllEntries();
      this.state.entries = data;
      const completed = data.filter(e=>e.pickupComplete).length;
      const issues = data.filter(e=>e.pickupComplete && !e.qualityCheck).length;
      this.state.stats = { total: data.length, completed, pending: data.length - completed, issues };
      this.render();
    }

    async loadArchive(){
      const data = await this.db.getArchivedEntries();
      this.state.archivedEntries = data;
      this.state.showArchive = true;
      this.render();
    }

    formatDate(d){
      if (!d) return '';
      let dt;
      if (/^\d{4}-\d{2}-\d{2}$/.test(d)) {
        const [yy, mm, dd] = d.split('-').map(Number);
        dt = new Date(yy, mm - 1, dd);
      } else {
        dt = new Date(d);
      }
      if (isNaN(dt)) return d;
      const mm = String(dt.getMonth() + 1).padStart(2, '0');
      const dd = String(dt.getDate()).padStart(2, '0');
      const yyyy = dt.getFullYear();
      return `${mm}-${dd}-${yyyy}`;
    }

    // Convert any date format to yyyy-MM-dd for HTML date inputs
    toInputDate(d){
      if (!d) return '';
      if (/^\d{4}-\d{2}-\d{2}$/.test(d)) return d;
      const dt = new Date(d);
      if (isNaN(dt)) return '';
      return dt.toISOString().split('T')[0];
    }

    filtered(){
      const t = this.state.search.toLowerCase();
      return this.state.entries.filter(e=>{
        const hit = (e.client||'').toLowerCase().includes(t)
          || (e.shipTo||'').toLowerCase().includes(t)
          || (e.order||'').toLowerCase().includes(t)
          || (e.carrier||'').toLowerCase().includes(t)
          || (e.pickupNum||'').toLowerCase().includes(t);
        const f = this.state.filter;
        const ok = f==='all' || (f==='completed'&&e.pickupComplete) || (f==='pending'&&!e.pickupComplete) || (f==='issues'&&(e.pickupComplete&&!e.qualityCheck));
        return hit && ok;
      }).sort((a, b) => {
        const dateA = new Date(a.scheduledDate || 0);
        const dateB = new Date(b.scheduledDate || 0);
        return dateA - dateB;
      });
    }

    async add(){
      const fd = this.state.newForm;
      // Validate required fields
      if (!fd.carrier) {
        alert('Carrier is required.');
        return;
      }
      if (!fd.shipTo) {
        alert('Ship To is required.');
        return;
      }
      if (!fd.scheduledDate) {
        alert('Scheduled Date is required.');
        return;
      }
      // Set date to today
      fd.date = new Date().toISOString().split('T')[0];
      fd.createdBy = this.state.userName;
      await this.db.addEntry(fd);
      this.state.showAdd = false;
      await this.load();
    }

    async updateField(id, field, value) {
      // Prevent duplicate updates
      const updateKey = `${id}-${field}`;
      if (this.state.updating.has(updateKey)) {
        return;
      }

      this.state.updating.add(updateKey);

      try {
        const i = this.state.entries.findIndex(e => String(e.id) === String(id));
        if (i < 0) return;

        const entry = { ...this.state.entries[i], [field]: value };
        const now = new Date();
        const timestamp = now.toLocaleString('en-US', { month: '2-digit', day: '2-digit', year: 'numeric', hour: '2-digit', minute: '2-digit' });

        if (field === 'pickupComplete') {
          const y = now.getFullYear();
          const m = String(now.getMonth() + 1).padStart(2, '0');
          const d = String(now.getDate()).padStart(2, '0');
          entry.completedDate = value ? `${y}-${m}-${d}` : '';
          entry.completedBy = value ? `${this.state.userName} (${timestamp})` : '';
        }

        if (field === 'printedByOps') {
          entry.printedBy = value ? `${this.state.userName} (${timestamp})` : '';
        }

        // Update local state immediately for better UX
        this.state.entries[i] = entry;
        this.render();

        // Then sync to backend
        await this.db.updateEntryById(id, entry);
        
      } finally {
        this.state.updating.delete(updateKey);
      }
    }

    async delete(id){
      if(!confirm('Delete this entry?')) return;
      const res = await this.db.deleteEntryById(id);
      if (res.success) {
        await this.load();
      } else {
        alert('Delete failed: ' + (res.error || 'Unknown error'));
      }
    }

    openEdit(id){
      const e = this.state.entries.find(x=>String(x.id)===String(id));
      if(!e) return;
      this.state.editing = { ...e };
      this.render();
    }

    closeEdit(){ this.state.editing=null; this.render(); }

    async saveEdit(){
      const e = this.state.editing;
      await this.db.updateEntryById(e.id, e);
      this.state.editing=null;
      await this.load();
    }

    async archive(){
      const res = await this.db.archiveCompleted();
      alert(`Archived ${res.archived||0} completed pickups`);
      await this.load();
    }

    setUser(name, email){
      if(!name || !email) {
        alert('Please enter both name and email.');
        return;
      }
      if(!email.toLowerCase().endsWith('@staciamericas.com')) {
        alert('Email must be a @staciamericas.com address.');
        return;
      }
      localStorage.setItem('pickupLogUser', name);
      localStorage.setItem('pickupLogEmail', email.toLowerCase());
      this.state.userName = name;
      this.state.userEmail = email.toLowerCase();
      this.state.showUserModal = false;
      this.init();
    }

    logout(){
      localStorage.removeItem('pickupLogUser');
      localStorage.removeItem('pickupLogEmail');
      this.state.userName = '';
      this.state.userEmail = '';
      this.state.showUserModal = true;
      this.render();
    }

    async handleBOLUpload(id, fileInput) {
      const file = fileInput.files[0];
      if (!file) return;
      
      if (file.size > 5 * 1024 * 1024) {
        alert('File too large. Maximum size is 5MB.');
        fileInput.value = '';
        return;
      }

      const allowedTypes = ['application/pdf', 'image/png', 'image/jpeg', 'image/jpg'];
      if (!allowedTypes.includes(file.type)) {
        alert('Invalid file type. Please upload PDF, PNG, or JPG files only.');
        fileInput.value = '';
        return;
      }

      this.state.uploadingFor = id;
      this.render();

      try {
        const reader = new FileReader();
        reader.onload = async (e) => {
          const base64 = e.target.result.split(',')[1];
          const res = await this.db.uploadBOL(id, file.name, base64, file.type);
          
          if (res.success) {
            alert('BOL uploaded successfully!');
            await this.load();
          } else {
            alert('Upload failed: ' + (res.error || 'Unknown error'));
          }
          
          this.state.uploadingFor = null;
          fileInput.value = '';
          this.render();
        };
        reader.onerror = () => {
          alert('Error reading file');
          this.state.uploadingFor = null;
          fileInput.value = '';
          this.render();
        };
        reader.readAsDataURL(file);
      } catch (error) {
        alert('Upload error: ' + error.message);
        this.state.uploadingFor = null;
        fileInput.value = '';
        this.render();
      }
    }

    bindTableEvents() {
      const table = document.querySelector('tbody');
      if (!table) return;

      table.onchange = (ev) => {
        const t = ev.target;
        if (t.matches('input[type="checkbox"][data-field]')) {
          const row = t.closest('tr[data-id]');
          const id = row?.dataset.id;
          const field = t.dataset.field;
          if (id && field) {
            // Prevent the checkbox from visually changing until update completes
            const currentValue = t.checked;
            this.updateField(id, field, currentValue);
          }
        }
        if (t.matches('input[type="file"][data-bol-upload]')) {
          const row = t.closest('tr[data-id]');
          const id = row?.dataset.id;
          if (id) this.handleBOLUpload(id, t);
        }
      };

      table.onclick = (ev) => {
        const btnEdit = ev.target.closest('[data-edit]');
        if (btnEdit) { this.openEdit(btnEdit.dataset.id); return; }
        const btnDel = ev.target.closest('[data-del]');
        if (btnDel)  { this.delete(btnDel.dataset.id); return; }
      };
    }

    render(){
      const el = document.getElementById('app');

      if(this.state.showUserModal){
        el.innerHTML = `
          <div class="min-h-screen flex items-center justify-center">
            <div class="bg-white p-6 rounded-lg shadow max-w-sm w-full">
              <h2 class="text-2xl font-bold mb-2 text-indigo-900">Welcome</h2>
              <p class="text-gray-600 mb-4">Sign in with your Staci Americas credentials.</p>
              <input id="uname" class="w-full border rounded px-3 py-2 mb-3" placeholder="Full Name">
              <input id="uemail" type="email" class="w-full border rounded px-3 py-2 mb-3" placeholder="Email (@staciamericas.com)">
              <button id="ustart" class="w-full bg-indigo-600 text-white rounded px-3 py-2">Sign In</button>
            </div>
          </div>`;
        document.getElementById('ustart').onclick = () => this.setUser(
          document.getElementById('uname').value.trim(),
          document.getElementById('uemail').value.trim()
        );
        return;
      }

      if(this.state.showArchive){
        this.renderArchive();
        return;
      }

      const rows = this.filtered().map(e => `
        <tr class="hover:bg-gray-50" data-id="${e.id}">
          <td class="px-4 py-3 text-sm">${this.formatDate(e.date)}</td>
          <td class="px-4 py-3 text-sm font-medium">${e.client||''}</td>
          <td class="px-4 py-3 text-sm">${e.shipTo||''}</td>
          <td class="px-4 py-3 text-sm">${e.order||''}</td>
          <td class="px-4 py-3 text-sm text-center">${e.pallets||''}</td>
          <td class="px-4 py-3 text-sm">${e.carrier||''}</td>
          <td class="px-4 py-3 text-sm">${e.pickupNum||''}</td>
          <td class="px-4 py-3 text-sm">${this.formatDate(e.scheduledDate)}</td>
          <td class="px-4 py-3 text-center"><input type="checkbox" class="w-5 h-5" data-field="bolProvided" ${e.bolProvided?'checked':''} ${this.state.updating.has(`${e.id}-bolProvided`)?'disabled':''}></td>
          <td class="px-4 py-3 text-center" title="${e.printedBy || 'Not printed yet'}"><input type="checkbox" class="w-5 h-5" data-field="printedByOps" ${e.printedByOps?'checked':''} ${this.state.updating.has(`${e.id}-printedByOps`)?'disabled':''}></td>
          <td class="px-4 py-3 text-center" title="${e.completedBy || 'Not completed yet'}"><input type="checkbox" class="w-5 h-5" data-field="pickupComplete" ${e.pickupComplete?'checked':''} ${this.state.updating.has(`${e.id}-pickupComplete`)?'disabled':''}></td>
          <td class="px-4 py-3 text-sm">${this.formatDate(e.completedDate)}</td>
          <td class="px-4 py-3 text-center"><input type="checkbox" class="w-5 h-5" data-field="qualityCheck" ${e.qualityCheck?'checked':''} ${this.state.updating.has(`${e.id}-qualityCheck`)?'disabled':''}></td>
          <td class="px-4 py-3 text-sm max-w-xs truncate" title="${e.comments||''}">${e.comments||''}</td>
          <td class="px-4 py-3 text-xs text-gray-500">${e.createdBy||''}</td>
          <td class="px-4 py-3 text-sm">
            <div class="flex flex-col gap-1">
              ${e.bolFile ? `<a href="${e.bolFile}" target="_blank" class="text-blue-600 text-xs underline hover:text-blue-800">${e.bolFileName || 'View BOL'}</a>` : '<span class="text-gray-400 text-xs">No BOL</span>'}
              ${this.state.uploadingFor === e.id ? '<span class="text-xs text-orange-600">Uploading...</span>' : `<input type="file" accept=".pdf,.png,.jpg,.jpeg" data-bol-upload class="text-xs mt-1" style="font-size:10px;">`}
            </div>
          </td>
          <td class="px-4 py-3 text-center">
            <button class="text-indigo-600 ${this.isAdmin() ? 'mr-2' : ''}" data-edit data-id="${e.id}">‚úèÔ∏è</button>
            ${this.isAdmin() ? `<button class="text-red-600" data-del data-id="${e.id}">üóëÔ∏è</button>` : ''}
          </td>
        </tr>
      `).join('');

      el.innerHTML = `
        <div class="p-6">
          <div class="bg-white rounded-lg shadow p-6 mb-6 flex justify-between items-center">
            <div>
              <h1 class="text-3xl font-bold text-indigo-900 mb-1">Daily Pick Up Log</h1>
              <p class="text-gray-600">Transportation & Customer Service Operations</p>
              <p class="text-sm text-gray-500">Logged in as: <span class="text-indigo-600 font-semibold">${this.state.userName}</span> (${this.state.userEmail}) <button onclick="app.logout()" class="text-red-500 underline ml-2">Logout</button></p>
              ${this.state.bolFolderUrl ? `<p class="text-xs text-gray-500 mt-1">üìÅ <a href="${this.state.bolFolderUrl}" target="_blank" class="text-blue-600 underline">View BOL Files Folder</a></p>` : ''}
            </div>
            <div class="flex gap-2">
              <button class="bg-gray-600 text-white px-4 py-2 rounded" onclick="app.load()">üîÑ Refresh</button>
              <button class="bg-green-600 text-white px-4 py-2 rounded" onclick="app.state.showAdd=true; app.state.newForm=app.emptyForm(); app.render()">‚ûï Add</button>
              <button class="bg-indigo-600 text-white px-4 py-2 rounded" onclick="app.archive()">üìÅ Archive Now</button>
              <button class="bg-purple-600 text-white px-4 py-2 rounded" onclick="app.loadArchive()">üìÇ View Archive</button>
            </div>
          </div>

          <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-6">
            ${this.statCard('Total Pickups', this.state.stats.total, 'üì¶')}
            ${this.statCard('Completed', this.state.stats.completed, '‚úÖ')}
            ${this.statCard('Pending', this.state.stats.pending, '‚è≥')}
            ${this.statCard('Issues', this.state.stats.issues, '‚ö†Ô∏è')}
          </div>

          <div class="bg-white rounded-lg shadow p-4 mb-6 flex items-center gap-4">
            <div class="flex-1 relative">
              <input class="w-full border rounded px-3 py-2 pl-9" placeholder="Search..."
                value="${this.state.search}" oninput="app.state.search=this.value; app.render()">
              <span class="absolute left-3 top-2.5 text-gray-400">üîç</span>
            </div>
            <select class="border rounded px-3 py-2" onchange="app.state.filter=this.value; app.render()">
              <option value="all" ${this.state.filter==='all'?'selected':''}>All</option>
              <option value="completed" ${this.state.filter==='completed'?'selected':''}>Completed</option>
              <option value="pending" ${this.state.filter==='pending'?'selected':''}>Pending</option>
              <option value="issues" ${this.state.filter==='issues'?'selected':''}>Issues</option>
            </select>
          </div>

          <div class="bg-white rounded-lg shadow overflow-x-auto">
            <table class="w-full">
              <thead class="bg-indigo-900 text-white">
                <tr>
                  <th class="px-4 py-3 text-left">Date</th>
                  <th class="px-4 py-3 text-left">Client</th>
                  <th class="px-4 py-3 text-left">Ship To</th>
                  <th class="px-4 py-3 text-left">Order#</th>
                  <th class="px-4 py-3 text-left">Pallets</th>
                  <th class="px-4 py-3 text-left">Carrier</th>
                  <th class="px-4 py-3 text-left">Pickup#</th>
                  <th class="px-4 py-3 text-left">Scheduled</th>
                  <th class="px-4 py-3 text-center">BOL</th>
                  <th class="px-4 py-3 text-center">OPS</th>
                  <th class="px-4 py-3 text-center">Complete</th>
                  <th class="px-4 py-3 text-left">Completed</th>
                  <th class="px-4 py-3 text-center">QC</th>
                  <th class="px-4 py-3 text-left">Comments</th>
                  <th class="px-4 py-3 text-left">Created By</th>
                  <th class="px-4 py-3 text-left">BOL File</th>
                  <th class="px-4 py-3 text-center">Actions</th>
                </tr>
              </thead>
              <tbody>${rows || `<tr><td colspan="17" class="text-center py-10 text-gray-500">No entries</td></tr>`}</tbody>
            </table>
          </div>
        </div>
        ${this.state.showAdd ? this.addModal() : ''}
        ${this.state.editing ? this.editModal() : ''}
      `;
      this.bindTableEvents();
    }

    renderArchive(){
      const el = document.getElementById('app');
      const rows = this.state.archivedEntries.map(e => `
        <tr class="hover:bg-gray-50">
          <td class="px-4 py-3 text-sm">${this.formatDate(e.date)}</td>
          <td class="px-4 py-3 text-sm font-medium">${e.client||''}</td>
          <td class="px-4 py-3 text-sm">${e.shipTo||''}</td>
          <td class="px-4 py-3 text-sm">${e.order||''}</td>
          <td class="px-4 py-3 text-sm text-center">${e.pallets||''}</td>
          <td class="px-4 py-3 text-sm">${e.carrier||''}</td>
          <td class="px-4 py-3 text-sm">${e.pickupNum||''}</td>
          <td class="px-4 py-3 text-sm">${this.formatDate(e.completedDate)}</td>
          <td class="px-4 py-3 text-sm">${e.createdBy||''}</td>
          <td class="px-4 py-3 text-sm">${e.bolFile ? `<a href="${e.bolFile}" target="_blank" class="text-blue-600 underline">${e.bolFileName || 'View'}</a>` : 'N/A'}</td>
        </tr>
      `).join('');

      el.innerHTML = `
        <div class="p-6">
          <div class="bg-white rounded-lg shadow p-6 mb-6 flex justify-between items-center">
            <div>
              <h1 class="text-3xl font-bold text-indigo-900 mb-1">üìÇ Archived Pickups</h1>
              <p class="text-gray-600">Completed pickups (auto-archived after ${CONFIG.AUTO_ARCHIVE_DAYS} days)</p>
            </div>
            <button class="bg-indigo-600 text-white px-4 py-2 rounded" onclick="app.state.showArchive=false; app.render()">‚Üê Back to Active</button>
          </div>

          <div class="bg-white rounded-lg shadow overflow-x-auto">
            <table class="w-full">
              <thead class="bg-gray-700 text-white">
                <tr>
                  <th class="px-4 py-3 text-left">Date</th>
                  <th class="px-4 py-3 text-left">Client</th>
                  <th class="px-4 py-3 text-left">Ship To</th>
                  <th class="px-4 py-3 text-left">Order#</th>
                  <th class="px-4 py-3 text-left">Pallets</th>
                  <th class="px-4 py-3 text-left">Carrier</th>
                  <th class="px-4 py-3 text-left">Pickup#</th>
                  <th class="px-4 py-3 text-left">Completed</th>
                  <th class="px-4 py-3 text-left">Created By</th>
                  <th class="px-4 py-3 text-left">BOL</th>
                </tr>
              </thead>
              <tbody>${rows || `<tr><td colspan="10" class="text-center py-10 text-gray-500">No archived entries</td></tr>`}</tbody>
            </table>
          </div>
        </div>
      `;
    }

    statCard(label, value, icon){
      return `<div class="bg-white p-4 rounded shadow"><div class="flex justify-between"><div><p class="text-gray-500 text-sm">${label}</p><p class="text-2xl font-bold">${value}</p></div><div class="text-3xl">${icon}</div></div></div>`;
    }

    addModal(){
      const f = this.state.newForm;
      return `
      <div class="fixed inset-0 bg-black/50 flex items-center justify-center z-50">
        <div class="bg-white rounded-lg shadow p-6 w-full max-w-2xl max-h-[90vh] overflow-y-auto">
          <div class="flex justify-between items-center mb-4">
            <h2 class="text-2xl font-bold text-indigo-900">Add Pickup</h2>
            <button class="text-2xl" onclick="app.state.showAdd=false; app.render()">√ó</button>
          </div>
          <div class="grid grid-cols-2 gap-4">
            <div>
              <label class="text-sm block mb-1">Entry Date</label>
              <input type="date" class="w-full border rounded px-3 py-2 bg-gray-100" value="${new Date().toISOString().split('T')[0]}" readonly>
            </div>
            <div>
              <label class="text-sm block mb-1">Client</label>
              <select class="w-full border rounded px-3 py-2" onchange="app.state.newForm.client=this.value">
                <option value="">Select Client...</option>
                ${CLIENTS.map(c => `<option value="${c}" ${f.client===c?'selected':''}>${c}</option>`).join('')}
              </select>
            </div>
            <div>
              <label class="text-sm block mb-1">Ship To <span class="text-red-500">*</span></label>
              <input class="w-full border rounded px-3 py-2" value="${f.shipTo||''}" onchange="app.state.newForm.shipTo=this.value" required>
            </div>
            <div>
              <label class="text-sm block mb-1">Order#</label>
              <input class="w-full border rounded px-3 py-2" value="${f.order||''}" onchange="app.state.newForm.order=this.value">
            </div>
            <div>
              <label class="text-sm block mb-1">Pallets</label>
              <input type="number" class="w-full border rounded px-3 py-2" value="${f.pallets||''}" onchange="app.state.newForm.pallets=this.value">
            </div>
            <div>
              <label class="text-sm block mb-1">Carrier <span class="text-red-500">*</span></label>
              <select class="w-full border rounded px-3 py-2" onchange="app.state.newForm.carrier=this.value" required>
                <option value="">Select Carrier...</option>
                ${CARRIERS.map(c => `<option value="${c}" ${f.carrier===c?'selected':''}>${c}</option>`).join('')}
              </select>
            </div>
            <div>
              <label class="text-sm block mb-1">Pickup#</label>
              <input class="w-full border rounded px-3 py-2" value="${f.pickupNum||''}" onchange="app.state.newForm.pickupNum=this.value">
            </div>
            <div>
              <label class="text-sm block mb-1">Scheduled Date <span class="text-red-500">*</span></label>
              <input type="date" class="w-full border rounded px-3 py-2" value="${this.toInputDate(f.scheduledDate)}" onchange="app.state.newForm.scheduledDate=this.value" required>
            </div>
            <div class="col-span-2">
              <label class="text-sm block mb-1">Created By: <strong>${this.state.userName}</strong></label>
            </div>
            <div class="col-span-2 grid grid-cols-4 gap-4 mt-2">
              <label class="flex items-center gap-2"><input type="checkbox" ${f.bolProvided?'checked':''} onchange="app.state.newForm.bolProvided=this.checked"> BOL</label>
              <label class="flex items-center gap-2"><input type="checkbox" ${f.printedByOps?'checked':''} onchange="app.state.newForm.printedByOps=this.checked"> OPS</label>
              <label class="flex items-center gap-2"><input type="checkbox" ${f.pickupComplete?'checked':''} onchange="app.state.newForm.pickupComplete=this.checked"> Complete</label>
              <label class="flex items-center gap-2"><input type="checkbox" ${f.qualityCheck?'checked':''} onchange="app.state.newForm.qualityCheck=this.checked"> QC</label>
            </div>
            <div class="col-span-2">
              <label class="text-sm block mb-1">Comments</label>
              <textarea rows="3" class="w-full border rounded px-3 py-2" onchange="app.state.newForm.comments=this.value">${f.comments||''}</textarea>
            </div>
          </div>
          <div class="flex gap-3 mt-5">
            <button class="flex-1 bg-indigo-600 text-white rounded px-4 py-2" onclick="app.add()">Add</button>
            <button class="flex-1 bg-gray-300 rounded px-4 py-2" onclick="app.state.showAdd=false; app.render()">Cancel</button>
          </div>
        </div>
      </div>`;
    }

    editModal(){
      const e = this.state.editing;
      return `
      <div class="fixed inset-0 bg-black/50 flex items-center justify-center z-50">
        <div class="bg-white rounded-lg shadow p-6 w-full max-w-2xl max-h-[90vh] overflow-y-auto">
          <div class="flex justify-between items-center mb-4">
            <h2 class="text-2xl font-bold text-indigo-900">Edit Pickup</h2>
            <button class="text-2xl" onclick="app.closeEdit()">√ó</button>
          </div>
          <div class="grid grid-cols-2 gap-4">
            <div>
              <label class="text-sm block mb-1">Date</label>
              <input type="date" class="w-full border rounded px-3 py-2" value="${this.toInputDate(e.date)}" onchange="app.state.editing.date=this.value">
            </div>
            <div>
              <label class="text-sm block mb-1">Client</label>
              <select class="w-full border rounded px-3 py-2" onchange="app.state.editing.client=this.value">
                <option value="">Select Client...</option>
                ${CLIENTS.map(c => `<option value="${c}" ${e.client===c?'selected':''}>${c}</option>`).join('')}
              </select>
            </div>
            <div>
              <label class="text-sm block mb-1">Ship To</label>
              <input class="w-full border rounded px-3 py-2" value="${e.shipTo||''}" onchange="app.state.editing.shipTo=this.value">
            </div>
            <div>
              <label class="text-sm block mb-1">Order#</label>
              <input class="w-full border rounded px-3 py-2" value="${e.order||''}" onchange="app.state.editing.order=this.value">
            </div>
            <div>
              <label class="text-sm block mb-1">Pallets</label>
              <input type="number" class="w-full border rounded px-3 py-2" value="${e.pallets||''}" onchange="app.state.editing.pallets=this.value">
            </div>
            <div>
              <label class="text-sm block mb-1">Carrier</label>
              <select class="w-full border rounded px-3 py-2" onchange="app.state.editing.carrier=this.value">
                <option value="">Select Carrier...</option>
                ${CARRIERS.map(c => `<option value="${c}" ${e.carrier===c?'selected':''}>${c}</option>`).join('')}
              </select>
            </div>
            <div>
              <label class="text-sm block mb-1">Pickup#</label>
              <input class="w-full border rounded px-3 py-2" value="${e.pickupNum||''}" onchange="app.state.editing.pickupNum=this.value">
            </div>
            <div>
              <label class="text-sm block mb-1">Scheduled</label>
              <input type="date" class="w-full border rounded px-3 py-2" value="${this.toInputDate(e.scheduledDate)}" onchange="app.state.editing.scheduledDate=this.value">
            </div>
            <div class="col-span-2">
              <label class="text-sm text-gray-600">Created by: <strong>${e.createdBy||'Unknown'}</strong></label>
            </div>
            <div class="col-span-2 grid grid-cols-4 gap-4 mt-2">
              <label class="flex items-center gap-2"><input type="checkbox" ${e.bolProvided?'checked':''} onchange="app.state.editing.bolProvided=this.checked"> BOL</label>
              <label class="flex items-center gap-2"><input type="checkbox" ${e.printedByOps?'checked':''} onchange="app.state.editing.printedByOps=this.checked"> OPS</label>
              <label class="flex items-center gap-2">
                <input type="checkbox" ${e.pickupComplete?'checked':''}
                  onchange="
                    if(this.checked){
                      const n=new Date();
                      const y=n.getFullYear();
                      const m=String(n.getMonth()+1).padStart(2,'0');
                      const d=String(n.getDate()).padStart(2,'0');
                      app.state.editing.pickupComplete=true;
                      app.state.editing.completedDate=\`\${y}-\${m}-\${d}\`;
                    }else{
                      app.state.editing.pickupComplete=false;
                      app.state.editing.completedDate='';
                    }">
                Complete
              </label>
              <label class="flex items-center gap-2"><input type="checkbox" ${e.qualityCheck?'checked':''} onchange="app.state.editing.qualityCheck=this.checked"> QC</label>
            </div>
            <div class="col-span-2">
              <label class="text-sm block mb-1">Comments</label>
              <textarea rows="3" class="w-full border rounded px-3 py-2" onchange="app.state.editing.comments=this.value">${e.comments||''}</textarea>
            </div>
          </div>
          <div class="flex gap-3 mt-5">
            <button class="flex-1 bg-indigo-600 text-white rounded px-4 py-2" onclick="app.saveEdit()">Save</button>
            <button class="flex-1 bg-gray-300 rounded px-4 py-2" onclick="app.closeEdit()">Cancel</button>
          </div>
        </div>
      </div>`;
    }
  }

  let app;
  window.addEventListener('DOMContentLoaded',()=>{ app=new PickupLogApp(); window.app=app; });
  </script>
</body>
</html>







